{"type":"cy:bean","properties":{"beanType@STRING":"cy:requiremodule","name@STRING":"TableBinder","dependencies@STRING":["/libs/bndly/data/scripts/cy/ui/Text","/libs/bndly/data/scripts/cy/StringUtil","/libs/bndly/data/scripts/cy/LabelFunctions","/libs/bndly/data/scripts/cy/RestBeans","/libs/bndly/data/scripts/cy/HTMLUtil","/libs/bndly/data/scripts/cy/Expression","/libs/bndly/data/scripts/cy/ui/ViewComponent"],"script@STRING":"var TableBinder = ViewComponent.extend({\r\n\tconstruct: function(config) {\r\n\t\tif (!config) {\r\n\t\t\tconfig = {};\r\n\t\t}\r\n\t\tif (config.dataProvider) {\r\n\t\t\tconfig.dataProvider.addListener(\"load\", this.dataLoaded, this);\r\n\t\t}\r\n\t\tthis.callSuper(arguments, config);\r\n\t},\r\n\tgenerateColumnDefinitions: function(entityType) {\r\n\t\tvar cols = [];\r\n\t\tvar proto = new RestBeans[entityType]();\r\n\t\tproto.members()\r\n\t\t\t\t.each(function(member) {\r\n\t\t\t\t\tvar type = proto.memberType(member);\r\n\t\t\t\t\tif (type === \"String\" || type === \"Number\" || type === \"Date\" || type === \"Boolean\") {\r\n\t\t\t\t\t\tcols.push({\r\n\t\t\t\t\t\t\tpath: member,\r\n\t\t\t\t\t\t\tlabelText: member\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}, this);\r\n\t\treturn cols;\r\n\t},\r\n\trenderColumnHeader: function(renderTarget) {\r\n\t\tthis.header = $(renderTarget)\r\n\t\t\t\t.append(\"<thead></thead>\")\r\n\t\t\t\t.children()\r\n\t\t\t\t.last();\r\n\t\tthis.headerRow = $(this.header)\r\n\t\t\t\t.append(\"<tr></tr>\")\r\n\t\t\t\t.children()\r\n\t\t\t\t.last();\r\n\t\tthis.headersByIndex = {};\r\n\t\tfor (var i in this.columns) {\r\n\t\t\tvar column = this.columns[i];\r\n\t\t\tvar label = column.labelText;\r\n\t\t\tif (!label) {\r\n\t\t\t\tlabel = column.path;\r\n\t\t\t}\r\n\t\t\tif (!label) {\r\n\t\t\t\tlabel = \"\";\r\n\t\t\t}\r\n\t\t\tthis.headersByIndex[i] = $(this.header)\r\n\t\t\t\t\t.append(\"<th></th>\")\r\n\t\t\t\t\t.children()\r\n\t\t\t\t\t.last();\r\n\t\t\tnew Text({value: label}).renderTo($(this.headersByIndex[i]));\r\n\t\t\tif (typeof (this.dataProvider.setSortField) === \"function\") {\r\n\t\t\t\tif (column.path && column.path.split(\".\").length === 1 && column.path !== \"id\") {\r\n\t\t\t\t\tvar icon = $(this.headersByIndex[i]).append(\"<i></i>\").children().last();\r\n\t\t\t\t\t$(icon).click(this.createSortByCallback(column, this.dataProvider, icon));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\tcreateSortByCallback: function(column, dataProvider, icon) {\r\n\t\tvar up = \"icon-arrow-up\";\r\n\t\tvar down = \"icon-arrow-down\";\r\n\t\tvar applyIcon = function() {\r\n\t\t\tif (dataProvider.sortAscending) {\r\n\t\t\t\t$(icon).addClass(up);\r\n\t\t\t\t$(icon).removeClass(down);\r\n\t\t\t} else {\r\n\t\t\t\t$(icon).addClass(down);\r\n\t\t\t\t$(icon).removeClass(up);\r\n\t\t\t}\r\n\t\t};\r\n\t\tapplyIcon();\r\n\t\treturn function() {\r\n\t\t\tif (dataProvider.sortField === column.path) {\r\n\t\t\t\tdataProvider.toggleSortDirection();\r\n\t\t\t} else {\r\n\t\t\t\tdataProvider.setSortField(column.path);\r\n\t\t\t}\r\n\t\t\tapplyIcon();\r\n\t\t\tdataProvider.loadPage();\r\n\t\t};\r\n\t},\r\n\trenderTableRows: function(renderTarget) {\r\n\t\tthis.body = $(renderTarget)\r\n\t\t\t\t.append(\"<tbody></tbody>\")\r\n\t\t\t\t.children()\r\n\t\t\t\t.last();\r\n\t},\r\n\tcreateActionCallback: function(_this, entry, event) {\r\n\t\treturn function() {\r\n\t\t\t_this.fireEvent(event, entry);\r\n\t\t};\r\n\t},\r\n\trerenderRows: function(items) {\r\n\t\tvar body = this.body;\r\n\t\t$(body)\r\n\t\t\t\t.children()\r\n\t\t\t\t.remove();\r\n\t\tvar columns = this.columns;\r\n\t\tif (body) {\r\n\t\t\titems.each(function(entry) {\r\n\t\t\t\tvar row = $(body)\r\n\t\t\t\t\t\t.append(\"<tr></tr>\")\r\n\t\t\t\t\t\t.children()\r\n\t\t\t\t\t\t.last();\r\n\t\t\t\tfor (var i in columns) {\r\n\t\t\t\t\tvar column = columns[i];\r\n\t\t\t\t\tvar cell = $(row)\r\n\t\t\t\t\t\t\t.append(\"<td></td>\")\r\n\t\t\t\t\t\t\t.children()\r\n\t\t\t\t\t\t\t.last();\r\n\t\t\t\t\tif (column.path) {\r\n\t\t\t\t\t\tvar cellValue = new Expression({\r\n\t\t\t\t\t\t\troot: entry,\r\n\t\t\t\t\t\t\tpath: column.path\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t.resolve();\r\n\t\t\t\t\t\tif (column.format) {\r\n\t\t\t\t\t\t\tcellValue = column.format(cellValue);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (cellValue === null || cellValue === undefined) {\r\n\t\t\t\t\t\t\tcellValue = \"\";\r\n\t\t\t\t\t\t} else if (cellValue instanceof Date) {\r\n\t\t\t\t\t\t\tif(column.asTime) {\r\n\t\t\t\t\t\t\t\tcellValue = StringUtil.formatTime(cellValue);\r\n\t\t\t\t\t\t\t} else if(column.asDateTime) {\r\n\t\t\t\t\t\t\t\tcellValue = StringUtil.formatDate(cellValue) + \" \" + StringUtil.formatTime(cellValue);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tcellValue = StringUtil.formatDate(cellValue);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else if (true === cellValue) {\r\n\t\t\t\t\t\t\tcellValue = \"yes\";\r\n\t\t\t\t\t\t} else if (false === cellValue) {\r\n\t\t\t\t\t\t\tcellValue = \"no\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (cellValue.clazzName && typeof (cellValue.clazzName) === \"function\") {\r\n\t\t\t\t\t\t\tcellValue = LabelFunctions(cellValue);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t$(cell).append(cellValue);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (column.actions) {\r\n\t\t\t\t\t\tvar actionsGroup = $(cell)\r\n\t\t\t\t\t\t\t\t.append(\"<div class=\\\"btn-group pull-right\\\"></div>\")\r\n\t\t\t\t\t\t\t\t.children()\r\n\t\t\t\t\t\t\t\t.last();\r\n\t\t\t\t\t\tfor (var j in column.actions) {\r\n\t\t\t\t\t\t\tvar\r\n\t\t\t\t\t\t\t\t\taction = column.actions[j],\r\n\t\t\t\t\t\t\t\t\tlabel = action.labelText,\r\n\t\t\t\t\t\t\t\t\tlink = action.link,\r\n\t\t\t\t\t\t\t\t\tapplyLinkToButton = function(e, btn) {\r\n\t\t\t\t\t\t\t\t\t\tif (e.hasLink(link)) {\r\n\t\t\t\t\t\t\t\t\t\t\t$(btn.element).removeAttr(\"disabled\");\r\n\t\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\t\t$(btn.element).attr(\"disabled\", \"\");\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tif (!label) {\r\n\t\t\t\t\t\t\t\tlabel = action.event;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tvar actionBtn = new Text({value: label, tag: \"button\", cls: \"btn btn-small\"});\r\n\t\t\t\t\t\t\tactionBtn.renderTo($(actionsGroup));\r\n\t\t\t\t\t\t\tactionBtn.element.click(this.createActionCallback(this, entry, action.event));\r\n\t\t\t\t\t\t\tif (link) {\r\n\t\t\t\t\t\t\t\tentry.addListener(\"changed\", function(e) {\r\n\t\t\t\t\t\t\t\t\tapplyLinkToButton(e, actionBtn);\r\n\t\t\t\t\t\t\t\t}, this);\r\n\t\t\t\t\t\t\t\tapplyLinkToButton(entry, actionBtn);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}, this);\r\n\t\t}\r\n\t},\r\n\trenderPaginationBar: function(renderTarget) {\r\n\t\tthis.paginationWrapper = $(renderTarget)\r\n\t\t\t\t.append(\"<div class=\\\"pagination\\\"></div>\")\r\n\t\t\t\t.children()\r\n\t\t\t\t.last();\r\n\t\tthis.rerenderPagingationBar();\r\n\t},\r\n\trerenderPagingationBar: function() {\r\n\t\tthis.paginationWrapper.children()\r\n\t\t\t\t.remove();\r\n\t\tthis.paginationList = $(this.paginationWrapper)\r\n\t\t\t\t.append(\"<ul></ul>\")\r\n\t\t\t\t.children()\r\n\t\t\t\t.last();\r\n\t\tvar curPage = this.dataProvider.getCurrentPage();\r\n\t\tvar total = this.dataProvider.getTotalPages();\r\n\r\n\t\tvar createPageLoadCallBack = function(pageIndex, dataProvider) {\r\n\t\t\treturn function() {\r\n\t\t\t\tdataProvider.setPageOffset((pageIndex - 1) * dataProvider.getPageSize());\r\n\t\t\t\tdataProvider.loadPage();\r\n\t\t\t\treturn false;\r\n\t\t\t};\r\n\t\t};\r\n\r\n\t\tvar bonusAttributes = {};\r\n\t\tvar disabled = false;\r\n\t\tif (curPage === 1) {\r\n\t\t\tbonusAttributes.class = \"disabled\";\r\n\t\t\tdisabled = true;\r\n\t\t}\r\n\t\t;\r\n\t\tthis.prevElement = $(this.paginationList)\r\n\t\t\t\t.append(\"<li \" + HTMLUtil.serializeBonusAttributes(bonusAttributes) + \"><a href=\\\"#\\\">&laquo;</a></li>\")\r\n\t\t\t\t.children()\r\n\t\t\t\t.last();\r\n\t\tif (!disabled) {\r\n\t\t\tthis.prevElement.click(createPageLoadCallBack(curPage - 1, this.dataProvider));\r\n\t\t} else {\r\n\t\t\tthis.prevElement.click(function() {\r\n\t\t\t\treturn false;\r\n\t\t\t});\r\n\t\t}\r\n\t\tfor (var i = 1; i <= total; i++) {\r\n\t\t\tbonusAttributes = {};\r\n\t\t\tdisabled = false;\r\n\t\t\tif (i === curPage) {\r\n\t\t\t\tbonusAttributes.class = \"disabled\";\r\n\t\t\t\tdisabled = true;\r\n\t\t\t}\r\n\t\t\tvar pageLink = $(this.paginationList)\r\n\t\t\t\t\t.append(\"<li \" + HTMLUtil.serializeBonusAttributes(bonusAttributes) + \"><a href=\\\"#\\\">\" + i + \"</a></li>\")\r\n\t\t\t\t\t.children()\r\n\t\t\t\t\t.last();\r\n\t\t\tif (!disabled) {\r\n\t\t\t\t$(pageLink)\r\n\t\t\t\t\t\t.click(createPageLoadCallBack(i, this.dataProvider));\r\n\t\t\t} else {\r\n\t\t\t\t$(pageLink)\r\n\t\t\t\t\t\t.click(function() {\r\n\t\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tbonusAttributes = {};\r\n\t\tdisabled = false;\r\n\t\tif (curPage >= total) {\r\n\t\t\tbonusAttributes.class = \"disabled\";\r\n\t\t\tdisabled = true;\r\n\t\t}\r\n\t\tthis.nextElement = $(this.paginationList)\r\n\t\t\t\t.append(\"<li \" + HTMLUtil.serializeBonusAttributes(bonusAttributes) + \"><a href=\\\"#\\\">&raquo;</a></li>\")\r\n\t\t\t\t.children()\r\n\t\t\t\t.last();\r\n\t\tif (!disabled) {\r\n\t\t\tthis.nextElement.click(createPageLoadCallBack(curPage + 1, this.dataProvider));\r\n\t\t} else {\r\n\t\t\tthis.nextElement.click(function() {\r\n\t\t\t\treturn false;\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n\trenderTo: function(renderTarget) {\r\n\t\tthis.table = $(renderTarget)\r\n\t\t\t\t.append(\"<table class=\\\"table table-striped table-hover\\\"></table>\")\r\n\t\t\t\t.children()\r\n\t\t\t\t.last();\r\n\t\tthis.renderColumnHeader(this.table);\r\n\t\tthis.renderTableRows(this.table);\r\n\t\tthis.renderPaginationBar(renderTarget);\r\n\r\n\t\tthis.dataProvider.loadPage();\r\n\t},\r\n\tdataLoaded: function(items) {\r\n\t\tthis.rerenderRows(items);\r\n\t\tthis.rerenderPagingationBar();\r\n\t}\r\n});\r\nreturn TableBinder;","initMethod@STRING":"","proxy@STRING":"","moduleId@STRING":""}}
