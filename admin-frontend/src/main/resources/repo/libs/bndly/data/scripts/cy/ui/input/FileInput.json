{"type":"cy:bean","properties":{"beanType@STRING":"cy:requiremodule","name@STRING":"FileInput","dependencies@STRING":["/libs/bndly/data/scripts/cy/ui/input/InputViewComponent","/libs/bndly/data/scripts/cy/RestBeans","/libs/bndly/data/scripts/cy/ui/input/InputTypeRegistry"],"script@STRING":"var FileInput = InputViewComponent.extend({\r\n\tconstruct: function(config) {\r\n\t\tif (!config) {\r\n\t\t\tconfig = {};\r\n\t\t}\r\n\t\tif (config.eager === undefined || config.eager === null) {\r\n\t\t\tconfig.eager = true;\r\n\t\t}\r\n\t\tthis.callSuper(arguments, config);\r\n\t},\r\n\tdestroy: function() {\r\n\t\tthis.invokeSuper(arguments);\r\n\t},\r\n\trenderTo: function(renderTarget) {\r\n\t\tthis.wrapperForm = $(renderTarget).append(\"<form/>\").children().last().hide();\r\n\t\tif (FileInput.prototype.__counter === undefined) {\r\n\t\t\tFileInput.prototype.__counter = 0;\r\n\t\t} else {\r\n\t\t\tFileInput.prototype.__counter += 1;\r\n\t\t}\r\n\t\tthis.wrapperForm.attr(\"id\", \"fileUploadForm\" + FileInput.prototype.__counter);\r\n\t\tthis.input = $(this.wrapperForm).append(\"<input type=\\\"file\\\" />\").children().last();\r\n\t\tthis.input.attr(\"id\", \"fileToUpload\" + FileInput.prototype.__counter);\r\n\t\t$(this.input).hide();\r\n\t\tif (this.id) {\r\n\t\t\t$(this.input).attr(\"id\", this.id);\r\n\t\t}\r\n\t\tif (this.name) {\r\n\t\t\t$(this.input).attr(\"name\", this.name);\r\n\t\t}\r\n\t\tthis.wrapperForm.attr(\"enctype\", \"multipart/form-data\");\r\n\t\tthis.wrapperForm.attr(\"method\", \"post\");\r\n\r\n\t\tthis.button = $(renderTarget).append(\"<a class=\\\"btn btn-small btn-primary\\\" href=\\\"#\\\"><i class=\\\"icon-upload icon-white\\\"></i> select</a>\").children().last();\r\n\t\tvar _input = this.input;\r\n\t\t$(this.button).click(function() {\r\n\t\t\t$(_input).click();\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tvar _this = this;\r\n\t\t$(this.input).change(function() {\r\n\t\t\t_this.fileSelected();\r\n\t\t\treturn false;\r\n\t\t});\r\n\t},\r\n\tisFileSelected: function() {\r\n\t\treturn this._fileSelected ? true : false;\r\n\t},\r\n\tfileSelected: function() {\r\n\t\tthis._fileSelected = true;\r\n\t\tthis.fireEvent(\"selected\", this);\r\n\t\t// just for testing purpose\r\n\t\tif(this.eager) {\r\n\t\t\tthis.upload();\r\n\t\t}\r\n\t},\r\n\tgetFileDescription: function(){\r\n\t\tvar f = document.getElementById(this.wrapperForm.attr(\"id\"));\r\n\t\tvar fd;\r\n\t\tif (f.getFormData && typeof (f.getFormData) === \"function\") {\r\n\t\t\tfd = f.getFormData();\r\n\t\t\tconsole.warn(\"failed to get file description\");\r\n\t\t\treturn undefined;\r\n\t\t} else {\r\n\t\t\tfd = new FormData();\r\n\t\t\tvar file = f.getElementsByTagName(\"input\")[0].files[0];\r\n\t\t\treturn file;\r\n\t\t}\r\n\t},\r\n\tupload: function(urlOverride) {\r\n\t\tif (urlOverride) {\r\n\t\t\tthis.uploadToUrl(urlOverride);\r\n\t\t} else {\r\n\t\t\tvar drb = new RestBeans.BinaryDataRestBean();\r\n\t\t\tvar _this = this;\r\n\r\n\t\t\tvar xhr = new XMLHttpRequest();\r\n\t\t\txhr.withCredentials = true;\r\n\t\t\tvar f = document.getElementById(this.wrapperForm.attr(\"id\"));\r\n\t\t\tvar fd;\r\n\t\t\tif (f.getFormData && typeof (f.getFormData) === \"function\") {\r\n\t\t\t\tfd = f.getFormData();\r\n\t\t\t} else {\r\n\t\t\t\tfd = new FormData();\r\n\t\t\t\tvar file = f.getElementsByTagName(\"input\")[0].files[0];\r\n\t\t\t\tdrb.setName(file.name);\r\n\t\t\t\tdrb.setContentType(file.type);\r\n\t\t\t\tif(!drb.getContentType()) {\r\n\t\t\t\t\tdrb.setContentType(null);\r\n\t\t\t\t}\r\n\t\t\t\tdrb.addSingleInvocationListener(\"notFound\", function(data) {\r\n\t\t\t\t\tdrb.persistAndReload();\t\t\t\t\t\t\r\n\t\t\t\t}, this);\r\n\t\t\t\tdrb.addSingleInvocationListener(\"reloaded\", function(data) {\r\n\t\t\t\t\tvar uploadLink = data.hasLink(\"upload\");\r\n\t\t\t\t\tif (uploadLink) {\r\n\t\t\t\t\t\tconsole.log(\"starting upload\");\r\n\t\t\t\t\t\tthis.wrapperForm.attr(\"action\", uploadLink.getHref());\r\n\t\t\t\t\t\txhr.open(\"POST\", uploadLink.getHref());\r\n\t\t\t\t\t\txhr.send(fd);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.log(\"missing upload link\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}, this);\r\n\t\t\t\tdrb.find();\r\n\t\t\t\tfd.append(\"fileToUpload\", file);\r\n\t\t\t}\r\n\r\n\t\t\t/* event listners */\r\n\t\t\txhr.upload.addEventListener(\"progress\", function(evt) {\r\n\t\t\t\tif (evt.lengthComputable) {\r\n\t\t\t\t\tvar percentComplete = Math.round(evt.loaded * 100 / evt.total);\r\n\t\t\t\t\tconsole.log(\"upload progress \" + percentComplete.toString() + \"%\");\r\n\t\t\t\t}\r\n\t\t\t}, false);\r\n\r\n\t\t\txhr.addEventListener(\"load\", function() {\r\n\t\t\t\tconsole.log(\"upload completed\");\r\n\t\t\t\t_this.fireEvent(\"uploaded\", this, drb);\r\n\t\t\t}, false);\r\n\t\t\t//xhr.addEventListener(\"error\", uploadFailed, false);\r\n\t\t\t//xhr.addEventListener(\"abort\", uploadCanceled, false);\r\n\t\t\t/* Be sure to change the url below to the url of your upload server side script */\r\n\r\n\r\n\t\t\t//this.wrapperForm.submit();\r\n\t\t}\r\n\t},\r\n\tuploadToUrl: function(url) {\r\n\t\tvar _this = this;\r\n\r\n\t\t\tvar xhr = new XMLHttpRequest();\r\n\t\t\txhr.withCredentials = true;\r\n\t\t\tvar f = document.getElementById(this.wrapperForm.attr(\"id\"));\r\n\t\t\tvar fd;\r\n\t\t\tif (f.getFormData && typeof (f.getFormData) === \"function\") {\r\n\t\t\t\tfd = f.getFormData();\r\n\t\t\t} else {\r\n\t\t\t\tfd = new FormData();\r\n\t\t\t\tvar file = f.getElementsByTagName(\"input\")[0].files[0];\r\n\t\t\t\tfd.append(\"fileToUpload\", file);\r\n\t\t\t\tif (url) {\r\n\t\t\t\t\tconsole.log(\"starting upload\");\r\n\t\t\t\t\tthis.wrapperForm.attr(\"action\", url);\r\n\t\t\t\t\txhr.open(\"POST\", url);\r\n\t\t\t\t\txhr.send(fd);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.log(\"missing upload link\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t/* event listners */\r\n\t\t\txhr.upload.addEventListener(\"progress\", function(evt) {\r\n\t\t\t\tif (evt.lengthComputable) {\r\n\t\t\t\t\tvar percentComplete = Math.round(evt.loaded * 100 / evt.total);\r\n\t\t\t\t\tconsole.log(\"upload progress \" + percentComplete.toString() + \"%\");\r\n\t\t\t\t}\r\n\t\t\t}, false);\r\n\r\n\t\t\txhr.addEventListener(\"load\", function() {\r\n\t\t\t\tconsole.log(\"upload completed\");\r\n\t\t\t\t_this.fireEvent(\"uploaded\", this);\r\n\t\t\t}, false);\r\n\t\t\t//xhr.addEventListener(\"error\", uploadFailed, false);\r\n\t\t\t//xhr.addEventListener(\"abort\", uploadCanceled, false);\r\n\t\t\t/* Be sure to change the url below to the url of your upload server side script */\r\n\r\n\r\n\t\t\t//this.wrapperForm.submit();\r\n\t},\r\n\tgetValue: function() {\r\n\t\treturn undefined;\r\n\t},\r\n\tsetValue: function(value) {\r\n\t}\r\n});\r\nInputTypeRegistry.register(\"FileInput\", FileInput);\r\nreturn FileInput;","initMethod@STRING":"","proxy@STRING":"","moduleId@STRING":""}}
